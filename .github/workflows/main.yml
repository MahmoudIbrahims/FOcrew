name: ğŸ CI/CD Pipeline for FOcrew (Python)
on:
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "src/**"
  pull_request:
    branches:
      - main
      - "release/**"

jobs:
  test_and_build:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # 1. Setup Python Environment
      - name: ğŸ› ï¸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Cache dependencies for faster runs

      # 2. Install Dependencies & Activate Venv Path (The fix for all path errors)
      - name: ğŸ“¦ Install project dependencies (using UV)
        run: |
          # 1. Install uv globally
          pip install uv
          # 2. Create the virtual environment (.venv)
          uv venv
          # 3. Install project dependencies and linter into the created .venv
          uv pip install -r src/requirements.txt
          uv pip install flake8
          
          # 4. **CRITICAL FIX:** Add the venv's 'bin' directory to the system PATH
          # This ensures 'pytest' and 'flake8' are found in subsequent steps.
          echo "VENV_PATH=$(pwd)/.venv/bin" >> $GITHUB_ENV
          echo "$VENV_PATH" >> $GITHUB_PATH

      # 3. Database Setup (Crucial step for a FastAPI project using Postgres)
      - name: ğŸ³ Start PostgreSQL Database
        run: |
          echo "Waiting for PostgreSQL service to be ready..."
          sleep 10

      # 4. Run Tests (Simple call, PATH handles the location)
      - name: ğŸ§ª Run Unit and Integration Tests
        run: |
          # Set the secure database connection string
          export DATABASE_URL="postgresql://postgres:${{ secrets.POSTGRES_TEST_PASSWORD }}@localhost:5432/FOcrew_DB"
          # Run tests. The shell finds 'pytest' via the updated PATH.
          pytest src/

      # 5. Run Linter (Simple call, PATH handles the location)
      - name: ğŸ” Run Linter (e.g., Flake8 or Black)
        run: |
          # Run flake8. The shell finds 'flake8' via the updated PATH.
          flake8 src/

    services:
      # Define the PostgreSQL container service needed for integration tests
      postgres:
        image: pgvector/pgvector:0.8.0-pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_TEST_PASSWORD }}
          POSTGRES_DB: FOcrew_DB
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
