name: ğŸ CI/CD Pipeline for FOcrew (Python)
on:
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "src/**"
  pull_request:
    branches:
      - main
      - "release/**"

jobs:
  test_and_build:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # 1. Setup Python Environment
      - name: ğŸ› ï¸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Cache dependencies for faster runs

      # 2. Install Dependencies (Corrected to use .venv)
      - name: ğŸ“¦ Install project dependencies (using UV)
        run: |
          # Install uv globally on the runner
          pip install uv
          # Create the virtual environment (.venv)
          uv venv
          # Install dependencies into the created .venv
          uv pip install -r src/requirements.txt
          # Also install linter (flake8) into the venv now for step 5
          ./.venv/bin/pip install flake8

      # 3. Database Setup (Crucial step for a FastAPI project using Postgres)
      - name: ğŸ³ Start PostgreSQL Database
        run: |
          echo "Waiting for PostgreSQL service to be ready..."
          # This pause is still needed to ensure the DB service is up
          sleep 10

      # 4. Run Tests (Now using the pytest executable from the .venv)
      - name: ğŸ§ª Run Unit and Integration Tests
        run: |
          # Sets the secure connection string
          export DATABASE_URL="postgresql://postgres:${{ secrets.POSTGRES_TEST_PASSWORD }}@localhost:5432/FOcrew_DB"
          # Runs tests using the executable installed in the .venv
          ./.venv/bin/pytest src/

      # 5. Run Linter (Now using the flake8 executable from the .venv)
      - name: ğŸ” Run Linter (e.g., Flake8 or Black)
        # Note: flake8 installation was moved to step 2 to simplify this step
        run: |
          # Run flake8 using the executable installed in the .venv
          ./.venv/bin/flake8 src/

    services:
      # Define the PostgreSQL container service needed for integration tests
      postgres:
        image: pgvector/pgvector:0.8.0-pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_TEST_PASSWORD }}
          POSTGRES_DB: FOcrew_DB
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
